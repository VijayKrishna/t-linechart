<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">

<!--
d3-enabled, reusable Polymer-element for a line-chart.

Example:

    <t-linechart></t-linechart>

@demo
-->
<dom-module id="t-linechart">

  <template>

    <style type="text/css">
      :host::shadow .axis path,
      :host::shadow .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
        stroke-width: 0.5px;
      }

/*      :host::shadow .x.axis path {
        display: visible;
      }*/

      :host::shadow .line {
        fill: none;
        stroke-width: 1.5px;
      }

      :host::shadow .svg-container { 
        display: inline-block;
        position: relative;
        width: 100%;
        padding-bottom: 50%;
        vertical-align: middle; 
        overflow: hidden; 
      }

      :host::shadow .svg-content { 
        display: inline-block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
      }
    </style>

    <h1>&lt;t-linechart&gt;</h1>
    
    <content></content>
    <div id="chart"></div>
  </template>

</dom-module>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script>

  Polymer({

    is: 't-linechart',

    properties: {

      xLabel: {
        type: String,
        value: 'x-axis'
      },

      yLabel: {
        type: String,
        value: 'y-axis'
      },

      color: {
        type: String,
        value: 'steelblue'
      },

      smooth : {
        type: Boolean,
        value: false
      },

      height: {
        type: Number,
        value: 300
      },

      xAxisScale: {
        type: String,
        value: 'linear'
      },

      yAxisScale: {
        type: String,
        value: 'linear'
      }

    },

    // Private Helpers 
    // TODO move to a utility library for usage by all chart elements.

    _getAxisScale: function (scaleName) {
      switch(scaleName) {
        case 'date': return d3.time.scale();
        case 'log': return d3.scale.log();
        default: return d3.scale.linear();
      }
    },

    //#region Global Event Listeners
    domReady: function() {
        this.windowResize();
    },

    windowResize: function() {
      if(!this.$ || !this.$.chart) {
        return;
      }

      this._draw(this.$.chart);
    },
    //#endregion

    // Element Lifecycle

    created: function () {
      
    },

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
      var that = this;
      // Add event handler for DOMContentLoaded
      if (document.readyState != 'loading') {
          this.domReady();
      } else {
          window.addEventListener('DOMContentLoaded', function () { that.domReady(); });
      }

      // Add event handler for window resize
      window.addEventListener("resize", function() { that.windowResize(); });

    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
      this._draw(this.$.chart);
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    _draw: function (chartSelection) {
      var ww = d3.select(chartSelection).property('clientWidth');

      var margin = {top: 20, right: 20, bottom: 30, left: 50},
      width = ww - margin.left - margin.right,
      height = this.height - margin.top - margin.bottom;

      var svg = d3.select(chartSelection).select("svg");
      var svgG;
      if(svg.empty()) {
        console.log("here");
        svg = d3.select(chartSelection).append("svg");
        svgG = svg.attr("width", parseInt(width + margin.left + margin.right))
          .attr("height", parseInt(height + margin.top + margin.bottom))
            .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      } else {
        svgG = svg.attr("width", parseInt(width + margin.left + margin.right))
          .attr("height", parseInt(height + margin.top + margin.bottom))
          .select("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      }  

      var that = this;

      d3.tsv("../data.tsv", function(error, data) {
        if (error) throw error;

        that._setupCanvas(data, svgG, height, width);

      });
    },

    _getInterpolation : function () {
      return this.smooth ? 'basis' : 'linear';
    },

    _setupCanvas : function (data, svgG, height, width) {

      var parseDate = d3.time.format("%d-%b-%y").parse;
      data.forEach(function(d) {
        d.date = parseDate(d.date);
        d.close = +d.close;
      });

      var x = this._getAxisScale(this.xAxisScale)
            .range([0, width])
            .domain(d3.extent(data, function(d) { return d.date; }));
      var y = this._getAxisScale(this.yAxisScale)
            .range([height, 0])
            .domain(d3.extent(data, function(d) { return d.close; }));

      var xAxis = d3.svg.axis()
          .scale(x)
          .orient('bottom')
          .ticks(parseInt(width * 0.01))

      if(this.xAxisScale === 'linear') {
        xAxis.tickFormat(d3.format("-s"));
      }

      var yAxis = d3.svg.axis()
          .scale(y)
          .orient("left")
          .ticks(parseInt(height * 0.01));

      if(this.yAxisScale === 'linear') {
        yAxis.tickFormat(d3.format("-s"));
      }

      svgG.selectAll("*").remove();

      svgG.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("x", width)
          .style("text-anchor", "end")
          .attr("dy", "-0.5em")
          .text(this.xLabel)

      svgG.append("g")
          .attr("class", "y axis")
          .call(yAxis)
        .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".5em")
          .style("text-anchor", "end")
          .text(this.yLabel);

      this._plot(data, svgG, x, y);
    },

    _plot : function (data, svgG, x, y) {
      var line = d3.svg.line()
      .interpolate(this._getInterpolation())
      .x(function(d) { return x(d.date); })
      .y(function(d) { return y(d.close); });

      svgG.append("path")
      .datum(data)
      .attr("class", "line")
      .style("stroke", this.color)
      .attr("d", line);
      
    }

  });

</script>
